<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>BALAFON — Elektron Dark Red</title>

<style>
  :root{
    --bg:#0a0b0f;
    --bg2:#0e1016;
    --panel:#12141a;
    --panel2:#0f1117;
    --ink:#e9eaee;
    --ink-dim:#9aa1ad;
    --red:#ff2a3c;
    --red2:#ff4d5a;
    --red-dim:rgba(255,42,60,.18);
    --line:rgba(255,255,255,.08);
    --line2:rgba(255,255,255,.12);
    --pad:#171a22;
    --knob:#0c0e13;
    --r:14px;
    --r-sm:12px;
    --r-xs:10px;
    --sh1:0 18px 55px rgba(0,0,0,.65);
    --led-on:#68ff3b;
    --led-off:#2a2f3b;
    /* Safe area insets for iPhone notch/home bar */
    --sat: env(safe-area-inset-top, 0px);
    --sar: env(safe-area-inset-right, 0px);
    --sab: env(safe-area-inset-bottom, 0px);
    --sal: env(safe-area-inset-left, 0px);
  }

  *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
  html { height:100%; }

  body {
    min-height:100%;
    background:
      radial-gradient(900px 600px at 15% 0%, rgba(255,42,60,.07), transparent 55%),
      linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
    color: var(--ink);
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    /* Safe area padding for iPhone */
    padding-top: calc(var(--sat) + 8px);
    padding-left: calc(var(--sal) + 12px);
    padding-right: calc(var(--sar) + 12px);
    padding-bottom: calc(var(--sab) + 20px);
    display: flex;
    flex-direction: column;
    align-items: center;
    /* Prevent overscroll bounce on iOS */
    overscroll-behavior: none;
  }

  /* ── TOP BAR ── */
  .top-bar {
    width: 100%;
    max-width: 980px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 0 12px;
    gap: 10px;
  }

  .top-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 10px 14px;
    border-radius: var(--r-sm);
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.04);
    color: var(--ink);
    text-decoration: none;
    font-size: 12px;
    letter-spacing: .4px;
    cursor: pointer;
    /* Touch target min 44px */
    min-height: 44px;
    -webkit-tap-highlight-color: transparent;
  }
  .top-btn:active { opacity: .75; transform: scale(.97); }
  .top-btn.start {
    border-color: rgba(255,42,60,.45);
    background: rgba(255,42,60,.12);
    box-shadow: 0 0 0 3px rgba(255,42,60,.08);
  }

  /* ── HEADER ── */
  header {
    text-align: center;
    margin-bottom: 14px;
    width: 100%;
  }
  header h1 {
    font-size: 22px;
    letter-spacing: 6px;
    text-transform: uppercase;
    color: var(--ink);
    font-weight: 900;
  }
  header h1::after {
    content: "";
    display: block;
    width: 140px;
    height: 3px;
    margin: 10px auto 0;
    border-radius: 999px;
    background: linear-gradient(90deg, transparent, rgba(255,42,60,.85), transparent);
  }
  header .subtitle {
    margin-top: 8px;
    font-size: 10px;
    letter-spacing: 3px;
    color: var(--ink-dim);
    text-transform: uppercase;
  }

  /* ── FRAME ── */
  .plugin-frame {
    width: 100%;
    max-width: 980px;
    background: linear-gradient(180deg, var(--panel) 0%, var(--panel2) 100%);
    border: 1px solid var(--line);
    border-radius: calc(var(--r) + 6px);
    box-shadow: var(--sh1);
    overflow: hidden;
    position: relative;
  }
  .plugin-frame::before {
    content: "";
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 6px;
    background: linear-gradient(90deg,
      rgba(255,255,255,.04) 0%,
      rgba(255,255,255,.04) 10%,
      rgba(255,42,60,.75) 10%,
      rgba(255,42,60,.75) 18%,
      rgba(255,255,255,.04) 18%);
    pointer-events: none;
    z-index: 1;
  }

  /* ── KEYBOARD SECTION ── */
  .keyboard-section {
    padding: 16px 12px 12px;
    background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.18));
    border-bottom: 1px solid var(--line);
    position: relative;
  }
  .keyboard-section::before {
    content: "";
    position: absolute;
    left: 0; right: 0; top: 0;
    height: 1px;
    background: rgba(255,42,60,.22);
  }

  /* Horizontal scroll container — iOS native momentum */
  .bars-container {
    display: flex;
    align-items: stretch;
    gap: 8px;
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch; /* iOS momentum scroll */
    overscroll-behavior-x: contain;
    padding: 8px 4px 10px;
    /* Hide scrollbar visually on iOS Safari */
    scrollbar-width: none;
  }
  .bars-container::-webkit-scrollbar { display: none; }

  .bar-wrapper {
    flex: 0 0 auto;
    width: 72px;
    border-radius: var(--r);
    background: rgba(255,255,255,.02);
    border: 1px solid rgba(255,255,255,.08);
    padding: 8px 8px 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    user-select: none;
    -webkit-user-select: none;
    -webkit-tap-highlight-color: transparent;
    cursor: pointer;
    touch-action: manipulation; /* Prevent scroll-cancel on tap */
    transition: border-color .12s, background .12s;
  }
  .bar-wrapper.active {
    border-color: rgba(255,42,60,.65);
    background: rgba(255,42,60,.08);
    box-shadow: 0 0 0 3px rgba(255,42,60,.10);
  }

  .note-label {
    font-size: 10px;
    letter-spacing: 2px;
    color: var(--ink-dim);
    text-transform: uppercase;
  }
  .bar-wrapper.active .note-label { color: var(--red); }

  .bar {
    width: 100%;
    height: 56px;
    border-radius: var(--r-sm);
    background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.20));
    background-color: var(--pad);
    border: 1px solid rgba(255,255,255,.10);
    box-shadow: 0 8px 14px rgba(0,0,0,.35);
  }
  .bar-wrapper.active .bar {
    background-color: rgba(255,42,60,.14);
    border-color: rgba(255,42,60,.62);
  }

  .resonator {
    width: 100%;
    height: 10px;
    border-radius: 999px;
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.10);
    overflow: hidden;
    position: relative;
  }
  .resonator::after {
    content: "";
    position: absolute;
    inset: 2px;
    border-radius: 999px;
    background: linear-gradient(90deg, rgba(255,42,60,.18), rgba(255,255,255,.05));
  }
  .bar-wrapper.active .resonator::after {
    background: linear-gradient(90deg, rgba(255,42,60,.8), rgba(255,42,60,.10));
  }

  /* ── CONTROLS ZONE ── */
  .controls-zone {
    display: flex;
    flex-direction: column; /* Stack vertically on mobile */
  }

  /* At ≥ 700px go side by side */
  @media (min-width: 700px) {
    .controls-zone {
      display: grid;
      grid-template-columns: 1fr 1fr;
    }
  }
  @media (min-width: 1040px) {
    .controls-zone {
      grid-template-columns: 200px 1fr 1fr 1fr;
    }
  }

  .panel {
    padding: 14px 14px 16px;
    border-top: 1px solid var(--line);
    background: rgba(255,255,255,.01);
  }
  @media (min-width: 700px) {
    .panel { border-right: 1px solid var(--line); }
    .panel:nth-child(2n) { border-right: none; }
  }
  @media (min-width: 1040px) {
    .panel:nth-child(2n) { border-right: 1px solid var(--line); }
    .panel:last-child { border-right: none; }
  }

  .panel-title {
    font-size: 10px;
    letter-spacing: 3px;
    color: var(--red);
    text-transform: uppercase;
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    gap: 10px;
    opacity: .95;
  }
  .panel-title::after {
    content: "";
    flex: 1;
    height: 1px;
    background: linear-gradient(90deg, var(--red-dim), transparent);
  }

  /* ── SLIDERS ── */
  .control-row {
    margin-bottom: 12px;
  }
  .control-label {
    font-size: 10px;
    letter-spacing: 2px;
    color: var(--ink-dim);
    text-transform: uppercase;
    margin-bottom: 6px;
    display: block;
  }
  .slider-container {
    display: flex;
    align-items: center;
    gap: 10px;
    height: 28px;
  }

  input[type=range] {
    -webkit-appearance: none;
    appearance: none;
    flex: 1;
    height: 6px;
    border-radius: 999px;
    outline: none;
    cursor: pointer;
    background: linear-gradient(90deg,
      rgba(255,42,60,.85) var(--pct, 50%),
      rgba(255,255,255,.10) var(--pct, 50%));
    /* Larger touch area on iOS */
    -webkit-tap-highlight-color: transparent;
  }
  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: rgba(255,255,255,.92);
    border: 2px solid rgba(255,42,60,.55);
    box-shadow: 0 6px 12px rgba(0,0,0,.45);
    /* Ensures 44px touch target via the range track */
    cursor: pointer;
  }
  input[type=range]::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: rgba(255,255,255,.92);
    border: 2px solid rgba(255,42,60,.55);
    box-shadow: 0 6px 12px rgba(0,0,0,.45);
    cursor: pointer;
  }

  .value-display {
    font-size: 11px;
    color: var(--ink);
    min-width: 32px;
    text-align: right;
    font-weight: 700;
    letter-spacing: .2px;
    white-space: nowrap;
  }

  /* ── KNOBS ── */
  .knobs-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
    align-content: start;
  }

  .knob-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
  }
  .knob-label {
    font-size: 10px;
    letter-spacing: 2px;
    color: var(--ink-dim);
    text-transform: uppercase;
    text-align: center;
  }
  .knob-value {
    font-size: 11px;
    color: var(--ink);
    font-weight: 700;
    letter-spacing: .2px;
    white-space: nowrap;
    max-width: 80px;
    overflow: hidden;
    text-overflow: ellipsis;
    text-align: center;
  }

  .knob-outer {
    position: relative;
    width: 56px;
    height: 56px;
    /* Touch target expansion */
    padding: 4px;
    margin: -4px;
    touch-action: none; /* Prevents scroll stealing for knob drag */
    -webkit-tap-highlight-color: transparent;
    cursor: grab;
  }
  .knob-outer:active { cursor: grabbing; }

  /* SVG-based knob ring — avoids conic-gradient + mask Safari bugs */
  .knob-svg {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
  }

  .knob-body {
    position: absolute;
    inset: 8px;
    border-radius: 50%;
    background:
      radial-gradient(circle at 32% 28%, rgba(255,255,255,.07), transparent 55%),
      linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.25));
    background-color: var(--knob);
    border: 1px solid rgba(255,255,255,.10);
    box-shadow: 0 10px 18px rgba(0,0,0,.55);
  }
  .knob-outer.dragging .knob-body {
    border-color: rgba(255,42,60,.62);
    box-shadow: 0 0 0 3px rgba(255,42,60,.10), 0 12px 20px rgba(0,0,0,.55);
  }

  .knob-indicator {
    position: absolute;
    inset: 8px;
    border-radius: 50%;
    pointer-events: none;
  }
  .knob-indicator::after {
    content: "";
    position: absolute;
    top: 5px;
    left: 50%;
    transform: translateX(-50%);
    width: 3px;
    height: 10px;
    border-radius: 2px;
    background: var(--red);
    box-shadow: 0 0 4px rgba(255,42,60,.5);
  }

  /* ── BYPASS BUTTONS ── */
  .bypass-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: rgba(255,255,255,.03);
    border: 1px solid rgba(255,255,255,.10);
    border-radius: var(--r-sm);
    color: var(--ink-dim);
    font-size: 11px;
    font-family: inherit;
    letter-spacing: 2px;
    padding: 10px 12px;
    cursor: pointer;
    text-transform: uppercase;
    margin-bottom: 14px;
    min-height: 44px;
    -webkit-tap-highlight-color: transparent;
    transition: background .15s, border-color .15s;
  }
  .bypass-btn:active { opacity: .8; }
  .bypass-btn .led {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--led-off);
    flex-shrink: 0;
  }
  .bypass-btn.active {
    border-color: rgba(255,42,60,.55);
    color: var(--ink);
    background: rgba(255,42,60,.12);
    box-shadow: 0 0 0 3px rgba(255,42,60,.08);
  }
  .bypass-btn.active .led {
    background: var(--led-on);
    box-shadow: 0 0 10px rgba(104,255,59,.35);
  }

  /* ── MODE BUTTONS ── */
  .mode-group {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    margin-top: 10px;
  }
  .mode-btn {
    background: rgba(255,255,255,.03);
    border: 1px solid rgba(255,255,255,.10);
    color: var(--ink-dim);
    font-size: 11px;
    font-family: inherit;
    padding: 9px 12px;
    border-radius: var(--r-sm);
    cursor: pointer;
    letter-spacing: 2px;
    text-transform: uppercase;
    min-height: 44px;
    -webkit-tap-highlight-color: transparent;
    transition: background .12s, border-color .12s;
  }
  .mode-btn:active { opacity: .8; }
  .mode-btn.active {
    background: rgba(255,42,60,.12);
    border-color: rgba(255,42,60,.55);
    color: var(--ink);
    box-shadow: 0 0 0 3px rgba(255,42,60,.08);
  }

  /* ── OUTPUT / VU / SCOPE ── */
  .output-section { margin-top: 14px; }

  .vu-meter {
    display: flex;
    gap: 6px;
    height: 64px;
  }
  .vu-bar {
    flex: 1;
    background: rgba(255,255,255,.03);
    border: 1px solid rgba(255,255,255,.10);
    border-radius: var(--r-xs);
    overflow: hidden;
    display: flex;
    align-items: flex-end;
  }
  .vu-fill {
    width: 100%;
    height: 0%;
    border-radius: var(--r-xs);
    background: linear-gradient(0deg,
      rgba(104,255,59,.95),
      rgba(255,204,34,.95),
      rgba(255,42,60,.95));
    transition: height .05s ease-out;
  }

  /* Canvas scope — responsive width */
  .scope-wrap {
    margin-top: 10px;
    border-radius: var(--r-sm);
    overflow: hidden;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.25);
    width: 100%;
    height: 56px;
  }
  .scope-wrap canvas {
    display: block;
    width: 100%;
    height: 100%;
  }

  /* ── KEYS LEGEND ── */
  .keys-legend {
    padding: 10px 14px;
    display: flex;
    gap: 6px;
    border-top: 1px solid var(--line);
    background: rgba(0,0,0,.10);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }
  .keys-legend::-webkit-scrollbar { display: none; }

  .key-chip {
    flex: 0 0 auto;
    background: rgba(255,255,255,.03);
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 12px;
    padding: 6px 10px;
    font-size: 11px;
    color: var(--ink-dim);
    white-space: nowrap;
  }
  .key-chip kbd {
    background: rgba(0,0,0,.20);
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 6px;
    padding: 2px 5px;
    color: var(--ink);
    margin-right: 4px;
  }

  /* ── STATUS BAR ── */
  .status-bar {
    padding: 10px 14px;
    background: rgba(0,0,0,.18);
    border-top: 1px solid var(--line);
    font-size: 11px;
    color: var(--ink-dim);
    letter-spacing: 1px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: space-between;
    align-items: center;
  }
  .status-left {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .status-led {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--led-on);
    box-shadow: 0 0 10px rgba(104,255,59,.35);
    flex-shrink: 0;
  }
  #status-note { color: var(--ink); font-weight: 700; }

  /* ── SCROLLBAR GLOBAL ── */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: rgba(255,255,255,.02); }
  ::-webkit-scrollbar-thumb { background: rgba(255,255,255,.10); border-radius: 999px; }

  /* ── RESPONSIVE TWEAKS ── */
  @media (max-width: 390px) {
    header h1 { font-size: 18px; letter-spacing: 5px; }
    .bar-wrapper { width: 66px; }
    .knob-outer { width: 52px; height: 52px; }
    .knobs-grid { gap: 10px; }
    .panel { padding: 12px; }
  }
</style>
</head>

<body>

<!-- TOP BAR (inline, not fixed — avoids iOS safe area conflicts) -->
<div class="top-bar">
  <a href="../../" class="top-btn">← Retour</a>
  <button id="startAudio" class="top-btn start">▶ Start Audio</button>
</div>

<header>
  <h1>BALAFON</h1>
  <div class="subtitle">Idiophone Mélodique · Xylophone à Résonateurs · Audio Plugin</div>
</header>

<div class="plugin-frame">

  <!-- KEYBOARD -->
  <div class="keyboard-section">
    <div class="bars-container" id="barsContainer"></div>
  </div>

  <!-- CONTROLS -->
  <div class="controls-zone">

    <!-- INSTRUMENT -->
    <div class="panel">
      <div class="panel-title">Instrument</div>
      <div class="control-row">
        <span class="control-label">Volume</span>
        <div class="slider-container">
          <input type="range" id="vol" min="0" max="100" value="80" oninput="updateSlider(this,'vol')">
          <span class="value-display" id="vol-val">80</span>
        </div>
      </div>
      <div class="control-row">
        <span class="control-label">Decay</span>
        <div class="slider-container">
          <input type="range" id="decay" min="0" max="100" value="65" oninput="updateSlider(this,'decay')">
          <span class="value-display" id="decay-val">65</span>
        </div>
      </div>
      <div class="control-row">
        <span class="control-label">Mallet Hardness</span>
        <div class="slider-container">
          <input type="range" id="hardness" min="0" max="100" value="50" oninput="updateSlider(this,'hardness')">
          <span class="value-display" id="hardness-val">50</span>
        </div>
      </div>
      <div class="control-row">
        <span class="control-label">Resonators</span>
        <div class="slider-container">
          <input type="range" id="resonance" min="0" max="100" value="40" oninput="updateSlider(this,'resonance')">
          <span class="value-display" id="resonance-val">40</span>
        </div>
      </div>
      <div class="output-section">
        <div class="panel-title" style="font-size:10px;">Output</div>
        <div class="vu-meter">
          <div class="vu-bar"><div class="vu-fill" id="vu-l"></div></div>
          <div class="vu-bar"><div class="vu-fill" id="vu-r"></div></div>
        </div>
        <div class="scope-wrap">
          <canvas id="scope"></canvas>
        </div>
      </div>
    </div>

    <!-- MOOG FILTER -->
    <div class="panel">
      <div class="panel-title">Moog Filter</div>
      <button class="bypass-btn" id="filter-bypass" onclick="toggleBypass('filter')">
        <span class="led"></span><span class="bypass-label">OFF</span>
      </button>
      <div class="knobs-grid">
        <div class="knob-wrap">
          <div class="knob-outer" id="knob-cutoff" data-value="0.6" data-param="filterCutoff">
            <svg class="knob-svg" viewBox="0 0 56 56" id="ring-cutoff"><circle cx="28" cy="28" r="22" fill="none" stroke="rgba(255,255,255,.08)" stroke-width="3"/><path id="arc-cutoff" fill="none" stroke="#ff2a3c" stroke-width="3" stroke-linecap="round"/></svg>
            <div class="knob-body"></div>
            <div class="knob-indicator"></div>
          </div>
          <div class="knob-label">Cutoff</div>
          <div class="knob-value" id="kv-cutoff">2400Hz</div>
        </div>
        <div class="knob-wrap">
          <div class="knob-outer" id="knob-resonance" data-value="0.3" data-param="filterRes">
            <svg class="knob-svg" viewBox="0 0 56 56"><circle cx="28" cy="28" r="22" fill="none" stroke="rgba(255,255,255,.08)" stroke-width="3"/><path id="arc-resonance" fill="none" stroke="#ff2a3c" stroke-width="3" stroke-linecap="round"/></svg>
            <div class="knob-body"></div>
            <div class="knob-indicator"></div>
          </div>
          <div class="knob-label">Resonance</div>
          <div class="knob-value" id="kv-resonance">0.30</div>
        </div>
        <div class="knob-wrap">
          <div class="knob-outer" id="knob-drive" data-value="0.2" data-param="filterDrive">
            <svg class="knob-svg" viewBox="0 0 56 56"><circle cx="28" cy="28" r="22" fill="none" stroke="rgba(255,255,255,.08)" stroke-width="3"/><path id="arc-drive" fill="none" stroke="#ff2a3c" stroke-width="3" stroke-linecap="round"/></svg>
            <div class="knob-body"></div>
            <div class="knob-indicator"></div>
          </div>
          <div class="knob-label">Drive</div>
          <div class="knob-value" id="kv-drive">0.20</div>
        </div>
        <div class="knob-wrap">
          <div class="knob-outer" id="knob-envamt" data-value="0.4" data-param="filterEnv">
            <svg class="knob-svg" viewBox="0 0 56 56"><circle cx="28" cy="28" r="22" fill="none" stroke="rgba(255,255,255,.08)" stroke-width="3"/><path id="arc-envamt" fill="none" stroke="#ff2a3c" stroke-width="3" stroke-linecap="round"/></svg>
            <div class="knob-body"></div>
            <div class="knob-indicator"></div>
          </div>
          <div class="knob-label">Env Amt</div>
          <div class="knob-value" id="kv-envamt">0.40</div>
        </div>
      </div>
      <div class="panel-title" style="margin-top:14px;font-size:10px;">Mode</div>
      <div class="mode-group">
        <button class="mode-btn active" onclick="setFilterMode('lowpass',this)">LP</button>
        <button class="mode-btn" onclick="setFilterMode('bandpass',this)">BP</button>
        <button class="mode-btn" onclick="setFilterMode('highpass',this)">HP</button>
      </div>
    </div>

    <!-- SPACE ECHO -->
    <div class="panel">
      <div class="panel-title">Space Echo</div>
      <button class="bypass-btn" id="echo-bypass" onclick="toggleBypass('echo')">
        <span class="led"></span><span class="bypass-label">OFF</span>
      </button>
      <div class="knobs-grid">
        <div class="knob-wrap">
          <div class="knob-outer" id="knob-etime" data-value="0.35" data-param="echoTime">
            <svg class="knob-svg" viewBox="0 0 56 56"><circle cx="28" cy="28" r="22" fill="none" stroke="rgba(255,255,255,.08)" stroke-width="3"/><path id="arc-etime" fill="none" stroke="#ff2a3c" stroke-width="3" stroke-linecap="round"/></svg>
            <div class="knob-body"></div>
            <div class="knob-indicator"></div>
          </div>
          <div class="knob-label">Time</div>
          <div class="knob-value" id="kv-etime">350ms</div>
        </div>
        <div class="knob-wrap">
          <div class="knob-outer" id="knob-efeed" data-value="0.45" data-param="echoFeedback">
            <svg class="knob-svg" viewBox="0 0 56 56"><circle cx="28" cy="28" r="22" fill="none" stroke="rgba(255,255,255,.08)" stroke-width="3"/><path id="arc-efeed" fill="none" stroke="#ff2a3c" stroke-width="3" stroke-linecap="round"/></svg>
            <div class="knob-body"></div>
            <div class="knob-indicator"></div>
          </div>
          <div class="knob-label">Feedback</div>
          <div class="knob-value" id="kv-efeed">0.45</div>
        </div>
        <div class="knob-wrap">
          <div class="knob-outer" id="knob-emix" data-value="0.4" data-param="echoMix">
            <svg class="knob-svg" viewBox="0 0 56 56"><circle cx="28" cy="28" r="22" fill="none" stroke="rgba(255,255,255,.08)" stroke-width="3"/><path id="arc-emix" fill="none" stroke="#ff2a3c" stroke-width="3" stroke-linecap="round"/></svg>
            <div class="knob-body"></div>
            <div class="knob-indicator"></div>
          </div>
          <div class="knob-label">Wet Mix</div>
          <div class="knob-value" id="kv-emix">0.40</div>
        </div>
        <div class="knob-wrap">
          <div class="knob-outer" id="knob-emod" data-value="0.25" data-param="echoMod">
            <svg class="knob-svg" viewBox="0 0 56 56"><circle cx="28" cy="28" r="22" fill="none" stroke="rgba(255,255,255,.08)" stroke-width="3"/><path id="arc-emod" fill="none" stroke="#ff2a3c" stroke-width="3" stroke-linecap="round"/></svg>
            <div class="knob-body"></div>
            <div class="knob-indicator"></div>
          </div>
          <div class="knob-label">Tape Wow</div>
          <div class="knob-value" id="kv-emod">0.25</div>
        </div>
      </div>
      <div class="panel-title" style="margin-top:14px;font-size:10px;">Sync</div>
      <div class="mode-group">
        <button class="mode-btn" onclick="setEchoSync('free',this)">Free</button>
        <button class="mode-btn active" onclick="setEchoSync('quarter',this)">1/4</button>
        <button class="mode-btn" onclick="setEchoSync('dotted',this)">3/8</button>
      </div>
    </div>

    <!-- TAPE -->
    <div class="panel">
      <div class="panel-title">Tape Saturation</div>
      <button class="bypass-btn" id="tape-bypass" onclick="toggleBypass('tape')">
        <span class="led"></span><span class="bypass-label">OFF</span>
      </button>
      <div class="knobs-grid">
        <div class="knob-wrap">
          <div class="knob-outer" id="knob-tsat" data-value="0.3" data-param="tapeSat">
            <svg class="knob-svg" viewBox="0 0 56 56"><circle cx="28" cy="28" r="22" fill="none" stroke="rgba(255,255,255,.08)" stroke-width="3"/><path id="arc-tsat" fill="none" stroke="#ff2a3c" stroke-width="3" stroke-linecap="round"/></svg>
            <div class="knob-body"></div>
            <div class="knob-indicator"></div>
          </div>
          <div class="knob-label">Saturation</div>
          <div class="knob-value" id="kv-tsat">0.30</div>
        </div>
        <div class="knob-wrap">
          <div class="knob-outer" id="knob-tbias" data-value="0.5" data-param="tapeBias">
            <svg class="knob-svg" viewBox="0 0 56 56"><circle cx="28" cy="28" r="22" fill="none" stroke="rgba(255,255,255,.08)" stroke-width="3"/><path id="arc-tbias" fill="none" stroke="#ff2a3c" stroke-width="3" stroke-linecap="round"/></svg>
            <div class="knob-body"></div>
            <div class="knob-indicator"></div>
          </div>
          <div class="knob-label">Bias</div>
          <div class="knob-value" id="kv-tbias">0.50</div>
        </div>
        <div class="knob-wrap">
          <div class="knob-outer" id="knob-thiss" data-value="0.2" data-param="tapeHiss">
            <svg class="knob-svg" viewBox="0 0 56 56"><circle cx="28" cy="28" r="22" fill="none" stroke="rgba(255,255,255,.08)" stroke-width="3"/><path id="arc-thiss" fill="none" stroke="#ff2a3c" stroke-width="3" stroke-linecap="round"/></svg>
            <div class="knob-body"></div>
            <div class="knob-indicator"></div>
          </div>
          <div class="knob-label">Tape Hiss</div>
          <div class="knob-value" id="kv-thiss">0.20</div>
        </div>
        <div class="knob-wrap">
          <div class="knob-outer" id="knob-tflutter" data-value="0.15" data-param="tapeFlutter">
            <svg class="knob-svg" viewBox="0 0 56 56"><circle cx="28" cy="28" r="22" fill="none" stroke="rgba(255,255,255,.08)" stroke-width="3"/><path id="arc-tflutter" fill="none" stroke="#ff2a3c" stroke-width="3" stroke-linecap="round"/></svg>
            <div class="knob-body"></div>
            <div class="knob-indicator"></div>
          </div>
          <div class="knob-label">Flutter</div>
          <div class="knob-value" id="kv-tflutter">0.15</div>
        </div>
      </div>
      <div class="panel-title" style="margin-top:14px;font-size:10px;">Tape Speed</div>
      <div class="mode-group">
        <button class="mode-btn active" onclick="setTapeSpeed('7ips',this)">7½</button>
        <button class="mode-btn" onclick="setTapeSpeed('15ips',this)">15</button>
        <button class="mode-btn" onclick="setTapeSpeed('30ips',this)">30</button>
      </div>
    </div>

  </div><!-- /controls-zone -->

  <div class="keys-legend" id="keysLegend"></div>

  <div class="status-bar">
    <div class="status-left">
      <div class="status-led"></div>
      <span>ENGINE ACTIF</span>
    </div>
    <span id="status-note">— Sélectionnez une note —</span>
    <span>44100 Hz · 32bit</span>
  </div>

</div><!-- /plugin-frame -->

<script>
// ─────────────────────────────────────────────────────────────────────────────
//  BALAFON — Audio Engine
// ─────────────────────────────────────────────────────────────────────────────

const NOTE_NAMES = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];

const BALAFON_NOTES = [
  {note:'C',oct:4,key:'a'},{note:'D',oct:4,key:'z'},{note:'E',oct:4,key:'e'},
  {note:'G',oct:4,key:'r'},{note:'A',oct:4,key:'t'},{note:'C',oct:5,key:'y'},
  {note:'D',oct:5,key:'u'},{note:'E',oct:5,key:'i'},{note:'G',oct:5,key:'o'},
  {note:'A',oct:5,key:'p'},{note:'C',oct:6,key:'q'},{note:'D',oct:6,key:'s'},
  {note:'E',oct:6,key:'d'},{note:'G',oct:6,key:'f'},{note:'A',oct:6,key:'g'},
];

function noteToFreq(note, oct) {
  const idx = NOTE_NAMES.indexOf(note);
  return 440 * Math.pow(2, (idx + (oct - 4)*12 - 9) / 12);
}

const P = {
  volume:0.8, decay:0.65, hardness:0.5, resonance:0.4, pitch:0,
  filterCutoff:0.6, filterRes:0.3, filterDrive:0.2, filterEnv:0.4,
  filterActive:false, filterMode:'lowpass',
  echoTime:0.35, echoFeedback:0.45, echoMix:0.4, echoMod:0.25,
  echoActive:false, echoSync:'quarter',
  tapeSat:0.3, tapeBias:0.5, tapeHiss:0.2, tapeFlutter:0.15,
  tapeActive:false, tapeSpeed:'7ips',
};

let actx=null, masterOut=null, analyser=null, instrumentBus=null;
let filterIn,filterDry,filterWet,filterOut,filterType='lowpass',filterNode,filterDriveGain;
let tapeIn,tapeDry,tapeWet,tapeOut,shaperNode,tapePreGain,tapePostGain;
let tapeFlutterDelay,tapeFlutterLFO,tapeFlutterDepth;
let hissGain,hissFilter,hissSource;
let echoIn,echoDry,echoWet,echoOut,delayNode,delayFeedback,echoWetGain,wowLFO,wowDepth;

function setSmooth(param, value, t=0.02){
  if (!actx) return;
  const now = actx.currentTime;
  try{ param.cancelScheduledValues(now); param.setTargetAtTime(value,now,t); }catch{}
}
function getCutoffHz(){ return 80 + Math.pow(P.filterCutoff,2)*(18000-80); }
function makeSatCurve(amount,bias){
  const n=1024, curve=new Float32Array(n), k=amount*80+1, b=(bias-0.5)*0.5;
  for(let i=0;i<n;i++){const x=(i*2/(n-1)-1)+b; curve[i]=(Math.PI+k)*x/(Math.PI+k*Math.abs(x));}
  return curve;
}

function initAudio(){
  if(actx) return;
  actx = new (window.AudioContext||window.webkitAudioContext)();
  masterOut = actx.createGain(); masterOut.gain.value = P.volume;
  analyser = actx.createAnalyser(); analyser.fftSize=1024; analyser.smoothingTimeConstant=0.8;
  masterOut.connect(analyser); analyser.connect(actx.destination);
  instrumentBus = actx.createGain(); instrumentBus.gain.value=1.0;

  // FILTER
  filterIn=actx.createGain(); filterDry=actx.createGain();
  filterWet=actx.createGain(); filterOut=actx.createGain();
  filterDriveGain=actx.createGain(); filterDriveGain.gain.value=1+P.filterDrive*4;
  filterNode=actx.createBiquadFilter(); filterNode.type=P.filterMode;
  filterNode.frequency.value=getCutoffHz(); filterNode.Q.value=P.filterRes*30;
  filterIn.connect(filterDry); filterIn.connect(filterDriveGain);
  filterDriveGain.connect(filterNode); filterNode.connect(filterWet);
  filterDry.connect(filterOut); filterWet.connect(filterOut);

  // TAPE
  tapeIn=actx.createGain(); tapeDry=actx.createGain();
  tapeWet=actx.createGain(); tapeOut=actx.createGain();
  tapePreGain=actx.createGain(); tapePreGain.gain.value=1+P.tapeSat*3;
  tapeFlutterDelay=actx.createDelay(0.05); tapeFlutterDelay.delayTime.value=0;
  tapeFlutterLFO=actx.createOscillator(); tapeFlutterLFO.type='sine';
  tapeFlutterDepth=actx.createGain(); tapeFlutterDepth.gain.value=0;
  tapeFlutterLFO.connect(tapeFlutterDepth);
  tapeFlutterDepth.connect(tapeFlutterDelay.delayTime);
  tapeFlutterLFO.start();
  shaperNode=actx.createWaveShaper();
  shaperNode.curve=makeSatCurve(P.tapeSat,P.tapeBias); shaperNode.oversample='4x';
  tapePostGain=actx.createGain(); tapePostGain.gain.value=0.85;
  tapeIn.connect(tapeDry); tapeIn.connect(tapePreGain);
  tapePreGain.connect(tapeFlutterDelay); tapeFlutterDelay.connect(shaperNode);
  shaperNode.connect(tapePostGain); tapePostGain.connect(tapeWet);
  tapeDry.connect(tapeOut); tapeWet.connect(tapeOut);
  const hissBuffer=actx.createBuffer(1,actx.sampleRate*2,actx.sampleRate);
  const data=hissBuffer.getChannelData(0);
  for(let i=0;i<data.length;i++) data[i]=Math.random()*2-1;
  hissSource=actx.createBufferSource(); hissSource.buffer=hissBuffer; hissSource.loop=true;
  hissFilter=actx.createBiquadFilter(); hissFilter.type='bandpass';
  hissFilter.frequency.value=6000; hissFilter.Q.value=0.5;
  hissGain=actx.createGain(); hissGain.gain.value=0;
  hissSource.connect(hissFilter); hissFilter.connect(hissGain);
  hissGain.connect(tapeOut); hissSource.start();

  // ECHO
  echoIn=actx.createGain(); echoDry=actx.createGain();
  echoWet=actx.createGain(); echoOut=actx.createGain();
  delayNode=actx.createDelay(4.0); delayNode.delayTime.value=P.echoTime;
  delayFeedback=actx.createGain(); delayFeedback.gain.value=P.echoFeedback;
  echoWetGain=actx.createGain(); echoWetGain.gain.value=1;
  wowLFO=actx.createOscillator(); wowLFO.type='sine'; wowLFO.frequency.value=2.2;
  wowDepth=actx.createGain(); wowDepth.gain.value=0;
  wowLFO.connect(wowDepth); wowDepth.connect(delayNode.delayTime); wowLFO.start();
  delayNode.connect(delayFeedback); delayFeedback.connect(delayNode);
  echoIn.connect(echoDry); echoIn.connect(delayNode);
  delayNode.connect(echoWetGain); echoWetGain.connect(echoWet);
  echoDry.connect(echoOut); echoWet.connect(echoOut);

  // CHAIN
  instrumentBus.connect(filterIn); filterOut.connect(tapeIn);
  tapeOut.connect(echoIn); echoOut.connect(masterOut);

  syncFX(); syncBypassUI(); startScope(); startVU();
}

function syncFX(){
  if(!actx) return;
  filterNode.type = filterType;
  setSmooth(filterNode.frequency, getCutoffHz(), 0.03);
  setSmooth(filterNode.Q, P.filterRes*30, 0.03);
  setSmooth(filterDriveGain.gain, 1+P.filterDrive*4, 0.03);
  const fW=P.filterActive?1:0;
  setSmooth(filterWet.gain,fW,0.02); setSmooth(filterDry.gain,1-fW,0.02);
  shaperNode.curve=makeSatCurve(P.tapeSat,P.tapeBias);
  setSmooth(tapePreGain.gain,1+P.tapeSat*3,0.02);
  const ipsRate=(P.tapeSpeed==='30ips')?6.0:(P.tapeSpeed==='15ips'?4.2:2.8);
  setSmooth(tapeFlutterDepth.gain,P.tapeFlutter*0.004,0.05);
  tapeFlutterLFO.frequency.setValueAtTime(ipsRate,actx.currentTime);
  const tW=P.tapeActive?1:0;
  setSmooth(tapeWet.gain,tW,0.02); setSmooth(tapeDry.gain,1-tW,0.02);
  setSmooth(hissGain.gain,P.tapeActive?(P.tapeHiss*0.02):0,0.08);
  setSmooth(delayNode.delayTime,P.echoTime,0.03);
  setSmooth(delayFeedback.gain,P.echoFeedback,0.03);
  setSmooth(wowDepth.gain,P.echoMod*0.01,0.08);
  const eW=P.echoActive?P.echoMix:0;
  setSmooth(echoWet.gain,eW,0.02); setSmooth(echoDry.gain,P.echoActive?(1-P.echoMix):1,0.02);
}

function playNote(freq){
  initAudio();
  if(actx.state==='suspended') actx.resume();
  const now=actx.currentTime, decay=0.3+P.decay*2.5, h=P.hardness;
  const pm=Math.pow(2,P.pitch/1200);
  const o1=actx.createOscillator(),o2=actx.createOscillator();
  const o3=actx.createOscillator(),o4=actx.createOscillator();
  o1.frequency.value=freq*pm; o2.frequency.value=freq*pm*3.92;
  o3.frequency.value=freq*pm*9.72; o4.frequency.value=freq*pm*2.01;
  o1.type='sine'; o2.type='sine'; o3.type='sine'; o4.type='triangle';
  const g1=actx.createGain(),g2=actx.createGain(),g3=actx.createGain(),g4=actx.createGain();
  const vel=0.6+h*0.4;
  g1.gain.setValueAtTime(vel*0.7,now); g1.gain.exponentialRampToValueAtTime(0.0001,now+decay);
  g2.gain.setValueAtTime(vel*(0.2+h*0.3),now); g2.gain.exponentialRampToValueAtTime(0.0001,now+decay*0.4);
  g3.gain.setValueAtTime(vel*0.08,now); g3.gain.exponentialRampToValueAtTime(0.0001,now+decay*0.2);
  g4.gain.setValueAtTime(vel*0.15,now); g4.gain.exponentialRampToValueAtTime(0.0001,now+decay*0.6);
  const resMod=actx.createGain(); resMod.gain.setValueAtTime(1+P.resonance*0.5,now);
  resMod.gain.linearRampToValueAtTime(1,now+0.08);
  const voice=actx.createGain(); voice.gain.value=1;
  o1.connect(g1);g1.connect(voice); o2.connect(g2);g2.connect(voice);
  o3.connect(g3);g3.connect(voice); o4.connect(g4);g4.connect(voice);
  voice.connect(resMod); resMod.connect(instrumentBus);
  if(filterNode){
    const base=getCutoffHz(), peak=Math.min(18000,base*(1+P.filterEnv*2));
    filterNode.frequency.cancelScheduledValues(now);
    filterNode.frequency.setValueAtTime(peak,now);
    filterNode.frequency.exponentialRampToValueAtTime(base,now+0.15);
  }
  [o1,o2,o3,o4].forEach(o=>{ o.start(now); o.stop(now+decay+0.1); });
  setTimeout(()=>{
    try{[o1,o2,o3,o4].forEach(o=>o.disconnect());}catch{}
    try{[g1,g2,g3,g4].forEach(g=>g.disconnect());}catch{}
    try{voice.disconnect();resMod.disconnect();}catch{}
  },(decay+0.3)*1000);
}

// ── BUILD KEYBOARD ──
const container = document.getElementById('barsContainer');
const keysLegend = document.getElementById('keysLegend');

BALAFON_NOTES.forEach((n, i) => {
  const freq = noteToFreq(n.note, n.oct);
  const wrapper = document.createElement('div');
  wrapper.className = 'bar-wrapper';
  wrapper.id = 'bar-' + i;
  wrapper.innerHTML =
    '<span class="note-label">' + n.note + n.oct + '</span>' +
    '<div class="bar"></div>' +
    '<div class="resonator"></div>';

  function activate(){
    wrapper.classList.add('active');
    playNote(freq);
    document.getElementById('status-note').textContent = '♩ ' + n.note + n.oct + ' — ' + Math.round(freq) + ' Hz';
    setTimeout(() => wrapper.classList.remove('active'), 220);
  }

  wrapper.addEventListener('mousedown', activate);
  /* FIX: touchstart on pad must not prevent scroll on the container
     Use touchend to trigger so vertical scroll is not blocked */
  wrapper.addEventListener('touchend', e => {
    e.preventDefault();
    activate();
  }, {passive: false});

  container.appendChild(wrapper);

  const chip = document.createElement('div');
  chip.className = 'key-chip';
  chip.innerHTML = '<kbd>' + n.key.toUpperCase() + '</kbd>' + n.note + n.oct;
  keysLegend.appendChild(chip);
});

const keyMap = {};
BALAFON_NOTES.forEach((n, i) => { keyMap[n.key] = i; });
document.addEventListener('keydown', e => {
  if(e.repeat) return;
  const idx = keyMap[e.key.toLowerCase()];
  if(idx === undefined) return;
  const wrapper = document.getElementById('bar-' + idx);
  if(!wrapper) return;
  const n = BALAFON_NOTES[idx];
  const f = noteToFreq(n.note, n.oct);
  wrapper.classList.add('active');
  playNote(f);
  document.getElementById('status-note').textContent = '♩ ' + n.note + n.oct + ' — ' + Math.round(f) + ' Hz';
  setTimeout(() => wrapper.classList.remove('active'), 220);
});

// ── SLIDERS ──
function updateSlider(el, id){
  const v = parseFloat(el.value);
  const pct = ((v - el.min) / (el.max - el.min) * 100).toFixed(0);
  el.style.setProperty('--pct', pct + '%');
  document.getElementById(id + '-val').textContent = v;
  if(id==='vol'){ P.volume=v/100; if(masterOut) setSmooth(masterOut.gain,P.volume,0.03); }
  if(id==='decay') P.decay=v/100;
  if(id==='hardness') P.hardness=v/100;
  if(id==='resonance') P.resonance=v/100;
}
document.querySelectorAll('input[type=range]').forEach(el => {
  const v=parseFloat(el.value), pct=((v-el.min)/(el.max-el.min)*100).toFixed(0);
  el.style.setProperty('--pct', pct+'%');
});

// ── KNOBS (SVG arc — cross-browser, no conic-gradient mask) ──
const knobDefs = {
  'cutoff':   {param:'filterCutoff',min:0,max:1,fmt:v=>Math.round(80+v*v*(18000-80))+'Hz',valId:'kv-cutoff'},
  'resonance':{param:'filterRes',   min:0,max:1,fmt:v=>v.toFixed(2),valId:'kv-resonance'},
  'drive':    {param:'filterDrive', min:0,max:1,fmt:v=>v.toFixed(2),valId:'kv-drive'},
  'envamt':   {param:'filterEnv',   min:0,max:1,fmt:v=>v.toFixed(2),valId:'kv-envamt'},
  'etime':    {param:'echoTime',    min:0.01,max:2,fmt:v=>Math.round(v*1000)+'ms',valId:'kv-etime'},
  'efeed':    {param:'echoFeedback',min:0,max:0.95,fmt:v=>v.toFixed(2),valId:'kv-efeed'},
  'emix':     {param:'echoMix',     min:0,max:1,fmt:v=>v.toFixed(2),valId:'kv-emix'},
  'emod':     {param:'echoMod',     min:0,max:1,fmt:v=>v.toFixed(2),valId:'kv-emod'},
  'tsat':     {param:'tapeSat',     min:0,max:1,fmt:v=>v.toFixed(2),valId:'kv-tsat'},
  'tbias':    {param:'tapeBias',    min:0,max:1,fmt:v=>v.toFixed(2),valId:'kv-tbias'},
  'thiss':    {param:'tapeHiss',    min:0,max:1,fmt:v=>v.toFixed(2),valId:'kv-thiss'},
  'tflutter': {param:'tapeFlutter', min:0,max:1,fmt:v=>v.toFixed(2),valId:'kv-tflutter'},
};

// SVG arc helper: draws arc on circle r=22, cx=cy=28, from -220° to +40° range (280° total)
function describeArc(norm){
  const cx=28,cy=28,r=22;
  const startDeg=-220, rangeDeg=280;
  const endDeg = startDeg + norm*rangeDeg;
  const toRad = d => d*Math.PI/180;
  const sx = cx + r*Math.cos(toRad(startDeg));
  const sy = cy + r*Math.sin(toRad(startDeg));
  const ex = cx + r*Math.cos(toRad(endDeg));
  const ey = cy + r*Math.sin(toRad(endDeg));
  const large = norm*rangeDeg > 180 ? 1 : 0;
  if(norm < 0.001) return '';
  if(norm > 0.999) {
    // Full arc as two halves (SVG can't draw 360° in one path)
    const mx = cx + r*Math.cos(toRad(startDeg+140));
    const my = cy + r*Math.sin(toRad(startDeg+140));
    return 'M '+sx+' '+sy+' A '+r+' '+r+' 0 1 1 '+mx+' '+my+' A '+r+' '+r+' 0 1 1 '+ex+' '+ey;
  }
  return 'M '+sx+' '+sy+' A '+r+' '+r+' 0 '+large+' 1 '+ex+' '+ey;
}

function setupKnob(el){
  const id = el.id.replace('knob-','');
  const def = knobDefs[id];
  if(!def) return;

  let value = parseFloat(el.dataset.value);
  let startY, startValue;

  const arc = document.getElementById('arc-'+id);
  const indicator = el.querySelector('.knob-indicator');

  function updateKnob(v){
    value = Math.max(def.min, Math.min(def.max, v));
    const norm = (value-def.min)/(def.max-def.min);
    // Rotate indicator dot: -135° to +135°
    const rot = -135 + norm*270;
    if(indicator) indicator.style.transform = 'rotate('+rot+'deg)';
    // SVG arc
    if(arc) arc.setAttribute('d', describeArc(norm));
    P[def.param] = value;
    document.getElementById(def.valId).textContent = def.fmt(value);
    if(actx) syncFX();
  }

  function onMove(clientY){
    const dy = startY - clientY;
    const range = def.max - def.min;
    updateKnob(startValue + dy * range / 200);
  }

  function onMouseMove(e){ onMove(e.clientY); }
  function onTouchMove(e){ e.preventDefault(); onMove(e.touches[0].clientY); }

  function onEnd(){
    el.classList.remove('dragging');
    document.removeEventListener('mousemove', onMouseMove);
    document.removeEventListener('mouseup', onEnd);
    document.removeEventListener('touchmove', onTouchMove);
    document.removeEventListener('touchend', onEnd);
  }

  el.addEventListener('mousedown', e => {
    e.preventDefault();
    el.classList.add('dragging');
    startY=e.clientY; startValue=value;
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onEnd);
  });

  el.addEventListener('touchstart', e => {
    e.preventDefault(); // prevent scroll only for knob drag
    el.classList.add('dragging');
    startY=e.touches[0].clientY; startValue=value;
    // passive:false required to call preventDefault in touchmove
    document.addEventListener('touchmove', onTouchMove, {passive:false});
    document.addEventListener('touchend', onEnd);
  }, {passive:false});

  updateKnob(value);
}

document.querySelectorAll('.knob-outer').forEach(setupKnob);

// ── BYPASS ──
function toggleBypass(fx){
  const btn = document.getElementById(fx+'-bypass');
  if(!btn) return;
  const on = btn.classList.toggle('active');
  const label = btn.querySelector('.bypass-label');
  if(label) label.textContent = on ? 'ON' : 'OFF';
  if(fx==='filter') P.filterActive=on;
  if(fx==='echo')   P.echoActive=on;
  if(fx==='tape')   P.tapeActive=on;
  if(actx) syncFX();
}
function syncBypassUI(){
  [['filter',P.filterActive],['echo',P.echoActive],['tape',P.tapeActive]].forEach(([fx,on])=>{
    const btn=document.getElementById(fx+'-bypass');
    if(!btn) return;
    btn.classList.toggle('active',!!on);
    const label=btn.querySelector('.bypass-label');
    if(label) label.textContent=on?'ON':'OFF';
  });
}

// ── MODE BUTTONS ──
function setFilterMode(mode,btn){
  filterType=mode; P.filterMode=mode;
  btn.closest('.panel').querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  if(actx) syncFX();
}
function setEchoSync(mode,btn){
  P.echoSync=mode;
  btn.closest('.panel').querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const bpm=120;
  if(mode==='quarter') P.echoTime=60/bpm;
  if(mode==='dotted')  P.echoTime=60/bpm*1.5;
  document.getElementById('kv-etime').textContent=Math.round(P.echoTime*1000)+'ms';
  if(actx) syncFX();
}
function setTapeSpeed(speed,btn){
  P.tapeSpeed=speed;
  btn.closest('.panel').querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  if(actx) syncFX();
}

// ── SCOPE (responsive canvas) ──
const scopeCanvas = document.getElementById('scope');
const scopeCtx = scopeCanvas.getContext('2d');

function resizeScope(){
  const wrap = scopeCanvas.parentElement;
  scopeCanvas.width = wrap.offsetWidth * (window.devicePixelRatio||1);
  scopeCanvas.height = wrap.offsetHeight * (window.devicePixelRatio||1);
  scopeCtx.scale(window.devicePixelRatio||1, window.devicePixelRatio||1);
}
window.addEventListener('resize', resizeScope);
resizeScope();

function startScope(){
  const data = new Uint8Array(analyser.frequencyBinCount);
  const W = () => scopeCanvas.width / (window.devicePixelRatio||1);
  const H = () => scopeCanvas.height / (window.devicePixelRatio||1);
  function draw(){
    requestAnimationFrame(draw);
    analyser.getByteTimeDomainData(data);
    scopeCtx.clearRect(0,0,W(),H());
    scopeCtx.fillStyle='rgba(0,0,0,.22)';
    scopeCtx.fillRect(0,0,W(),H());
    scopeCtx.strokeStyle='rgba(255,255,255,.08)';
    scopeCtx.lineWidth=0.7;
    scopeCtx.beginPath(); scopeCtx.moveTo(0,H()/2); scopeCtx.lineTo(W(),H()/2); scopeCtx.stroke();
    scopeCtx.strokeStyle='#ff2a3c'; scopeCtx.lineWidth=1.5;
    scopeCtx.beginPath();
    const slice=W()/data.length;
    for(let i=0;i<data.length;i++){
      const y=(data[i]/128)*H()/2;
      if(i===0) scopeCtx.moveTo(0,y); else scopeCtx.lineTo(i*slice,y);
    }
    scopeCtx.stroke();
  }
  draw();
}

// ── VU ──
function startVU(){
  const fd = new Uint8Array(analyser.frequencyBinCount);
  let pL=0,pR=0;
  function update(){
    requestAnimationFrame(update);
    analyser.getByteFrequencyData(fd);
    let rms=0; for(let i=0;i<fd.length;i++) rms+=fd[i]*fd[i];
    rms=Math.sqrt(rms/fd.length)/255;
    const j=(Math.random()-0.5)*0.04;
    pL=Math.max(pL*0.92, Math.min(1,rms*2.5+j));
    pR=Math.max(pR*0.92, Math.min(1,rms*2.5-j*0.5));
    document.getElementById('vu-l').style.height=(pL*100)+'%';
    document.getElementById('vu-r').style.height=(pR*100)+'%';
  }
  update();
}

// ── START AUDIO BUTTON ──
document.getElementById('startAudio').addEventListener('click', async () => {
  initAudio();
  if(actx && actx.state==='suspended') await actx.resume();
  document.getElementById('startAudio').textContent = '✓ Audio OK';
  document.getElementById('startAudio').style.borderColor = 'rgba(104,255,59,.55)';
  document.getElementById('startAudio').style.color = '#68ff3b';
});
</script>
</body>
</html>
