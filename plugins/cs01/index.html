<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>RhS01 — MacroOSC (Mono)</title>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Share+Tech+Mono&display=swap');

  :root{
    --bg:#0e0a06;
    --surface:#1a1208;
    --surface2:#231a0d;
    --line:#3a2a15;
    --accent:#e8a030;
    --accent2:#d4601a;
    --text:#f0e0c0;
    --text-dim:#886644;

    --cyan:#5dd4e8;
    --black:#080604;

    --radius:16px;
    --shadow: 0 30px 80px rgba(0,0,0,0.72), inset 0 1px 0 rgba(255,200,100,0.08);
  }

  *{box-sizing:border-box;margin:0;padding:0}
  body{
    min-height:100vh;
    background: var(--bg);
    color: var(--text);
    font-family: 'Rajdhani', sans-serif;
    padding: max(18px, env(safe-area-inset-top)) 14px max(18px, env(safe-area-inset-bottom));
    background-image:
      radial-gradient(ellipse at 20% 0%, rgba(160,80,20,0.12) 0%, transparent 60%),
      radial-gradient(ellipse at 80% 100%, rgba(80,40,10,0.15) 0%, transparent 60%);
    display:flex;
    justify-content:center;
  }

  .app{
    width: min(980px, 100%);
    display:flex;
    flex-direction:column;
    gap: 12px;
  }

  header{
    text-align:center;
    padding: 6px 6px 0;
  }
  header h1{
    font-family:'Share Tech Mono', monospace;
    letter-spacing:0.26em;
    font-size: 18px;
    color: var(--accent);
    text-shadow: 0 0 30px rgba(232,160,48,0.2);
  }
  header .sub{
    margin-top:8px;
    font-size: 11px;
    letter-spacing:0.22em;
    text-transform:uppercase;
    color: var(--text-dim);
  }

  .frame{
    border: 1px solid var(--line);
    border-radius: var(--radius);
    overflow:hidden;
    box-shadow: var(--shadow);
    background: linear-gradient(160deg, #1e1610 0%, #120d08 100%);
  }

  .top{
    display:flex;
    flex-direction:column;
    gap: 10px;
    padding: 14px;
    border-bottom: 1px solid var(--line);
  }

  .row{
    display:flex;
    gap:10px;
    align-items:stretch;
    flex-wrap:wrap;
  }

  .card{
    background: rgba(0,0,0,0.18);
    border: 1px solid rgba(0,0,0,0.35);
    border-radius: 14px;
    padding: 12px;
    flex: 1;
    min-width: 220px;
  }

  .title{
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom: 10px;
  }
  .title .label{
    font-family:'Share Tech Mono', monospace;
    color: var(--cyan);
    font-size: 11px;
    letter-spacing: 0.22em;
    text-transform: uppercase;
    white-space:nowrap;
  }
  .title .line{
    flex:1;
    height:1px;
    background: rgba(58,42,21,0.8);
  }

  /* Mode buttons (Wave -> Modes) */
  .modes{
    display:grid;
    grid-template-columns: repeat(2, minmax(0,1fr));
    gap: 8px;
  }
  .mode-btn{
    border: 1px solid rgba(0,0,0,0.6);
    background: rgba(0,0,0,0.28);
    color: rgba(240,224,192,0.85);
    border-radius: 12px;
    padding: 10px 10px;
    cursor:pointer;
    user-select:none;
    text-align:left;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
  }
  .mode-btn b{
    font-family:'Share Tech Mono', monospace;
    font-size: 12px;
    color: rgba(240,224,192,0.95);
    letter-spacing:0.08em;
  }
  .mode-btn span{
    font-size: 11px;
    color: var(--text-dim);
    letter-spacing:0.08em;
  }
  .mode-btn.active{
    border-color: rgba(93,212,232,0.85);
    box-shadow: 0 0 16px rgba(93,212,232,0.12);
    background: rgba(93,212,232,0.12);
  }
  .mode-btn.active b{ color: var(--cyan); }

  /* Sliders */
  .sliders{
    display:grid;
    grid-template-columns: repeat(2, minmax(0,1fr));
    gap: 10px;
  }

  .ctl{
    display:flex;
    flex-direction:column;
    gap: 6px;
  }
  .ctl .name{
    font-family:'Share Tech Mono', monospace;
    font-size: 10px;
    letter-spacing:0.22em;
    text-transform:uppercase;
    color: rgba(240,224,192,0.75);
    display:flex;
    justify-content:space-between;
    gap: 8px;
  }
  .ctl .val{
    color: var(--accent);
    letter-spacing:0.08em;
    font-size: 11px;
  }

  input[type=range]{
    -webkit-appearance:none;
    width:100%;
    height: 6px;
    border-radius: 999px;
    background: linear-gradient(90deg, var(--accent2) var(--pct,50%), rgba(0,0,0,0.35) var(--pct,50%));
    outline:none;
    cursor:pointer;
  }
  input[type=range]::-webkit-slider-thumb{
    -webkit-appearance:none;
    width: 18px; height: 18px;
    border-radius: 50%;
    background: radial-gradient(circle at 35% 35%, #e0b060, #9a6020);
    border: 1px solid rgba(255,200,80,0.35);
    box-shadow: 0 3px 10px rgba(0,0,0,0.55);
  }

  /* Keyboard */
  .kbd{
    padding: 12px 14px 14px;
    background: rgba(0,0,0,0.16);
  }
  .kbdTop{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
    margin-bottom: 10px;
  }
  .brand{
    display:flex;
    flex-direction:column;
    gap: 4px;
  }
  .brand .yam{ font-family:'Share Tech Mono', monospace; font-size: 12px; letter-spacing:0.18em; color: rgba(240,224,192,0.95); }
  .brand .cs01{ font-family:'Share Tech Mono', monospace; font-size: 26px; letter-spacing:-1px; color: var(--accent); }
  .brand .tag{ font-size: 10px; letter-spacing:0.22em; text-transform:uppercase; color: var(--text-dim); }

  .note{
    font-family:'Share Tech Mono', monospace;
    border: 1px solid rgba(93,212,232,0.7);
    color: var(--cyan);
    background: rgba(0,0,0,0.55);
    border-radius: 12px;
    padding: 8px 12px;
    min-width: 84px;
    text-align:center;
  }

  .piano{
    height: 180px;
    position: relative;
    background: var(--black);
    border: 1px solid rgba(58,42,21,0.7);
    border-radius: 14px;
    overflow:hidden;
  }
  .white-keys{
    display:flex;
    height:100%;
    gap: 1px;
    padding: 1px;
  }
  .white-key{
    flex:1;
    background: linear-gradient(180deg,#f5f5f5,#e8e8e8);
    border-radius: 0 0 10px 10px;
    border: 1px solid #ccc;
    cursor:pointer;
    box-shadow: 0 8px 14px rgba(0,0,0,0.28);
  }
  .white-key.active{ background: linear-gradient(180deg,#f7e4c1,#f0d39b); }

  .black-keys{
    position:absolute;
    top:0; left:0; right:0;
    height: 60%;
    pointer-events:none;
  }
  .black-key{
    pointer-events:all;
    position:absolute;
    height:100%;
    background: linear-gradient(180deg,#222,#111);
    border-radius: 0 0 8px 8px;
    border: 1px solid #000;
    box-shadow: 2px 10px 14px rgba(0,0,0,0.55);
    cursor:pointer;
  }
  .black-key.active{ background: linear-gradient(180deg,#3a2a15,#1a1208); }

  .footer{
    text-align:center;
    color: var(--text-dim);
    font-size: 10px;
    letter-spacing:0.22em;
    text-transform:uppercase;
    padding: 8px 0 0;
  }

  /* iPhone-ish: keep it comfy */
  @media (max-width: 430px){
    .modes{ grid-template-columns: 1fr; }
    .sliders{ grid-template-columns: 1fr; }
    .piano{ height: 160px; }
  }
</style>
</head>

<body>
  <div class="app">
    <header>
      <h1>RhS01 · MACRO OSC</h1>
      <div class="sub">Vintage · Mono · AudioWorklet (100% JS)</div>
    </header>

    <div class="frame">
      <div class="top">

        <div class="card">
          <div class="title"><div class="label">WAVE → MODE</div><div class="line"></div></div>
          <div class="modes" id="modeGrid">
            <!-- bound in JS -->
          </div>
        </div>

        <div class="row">
          <div class="card">
            <div class="title"><div class="label">OSC CONTROLS</div><div class="line"></div></div>
            <div class="sliders">
              <div class="ctl">
                <div class="name">TIMBRE <span class="val" id="v-timbre">0.50</span></div>
                <input type="range" id="timbre" min="0" max="100" value="50">
              </div>
              <div class="ctl">
                <div class="name">FM/FOLD <span class="val" id="v-fm">0.00</span></div>
                <input type="range" id="fm" min="0" max="100" value="0">
              </div>
              <div class="ctl">
                <div class="name">DETUNE <span class="val" id="v-detune">0.15</span></div>
                <input type="range" id="detune" min="0" max="100" value="15">
              </div>
              <div class="ctl">
                <div class="name">PWM <span class="val" id="v-pw">0.50</span></div>
                <input type="range" id="pw" min="5" max="95" value="50">
              </div>
            </div>
          </div>

          <div class="card">
            <div class="title"><div class="label">FILTER + AMP</div><div class="line"></div></div>
            <div class="sliders">
              <div class="ctl">
                <div class="name">CUTOFF <span class="val" id="v-cutoff">8000</span></div>
                <input type="range" id="cutoff" min="40" max="18000" value="8000">
              </div>
              <div class="ctl">
                <div class="name">RESO <span class="val" id="v-reso">1.00</span></div>
                <input type="range" id="resonance" min="10" max="1800" value="100">
              </div>

              <div class="ctl">
                <div class="name">ATTACK <span class="val" id="v-att">0.01</span></div>
                <input type="range" id="attack" min="1" max="400" value="1">
              </div>
              <div class="ctl">
                <div class="name">RELEASE <span class="val" id="v-rel">0.50</span></div>
                <input type="range" id="release" min="1" max="600" value="50">
              </div>

              <div class="ctl">
                <div class="name">SUSTAIN <span class="val" id="v-sus">0.70</span></div>
                <input type="range" id="sustain" min="0" max="100" value="70">
              </div>
              <div class="ctl">
                <div class="name">LEVEL <span class="val" id="v-level">0.70</span></div>
                <input type="range" id="level" min="0" max="100" value="70">
              </div>
            </div>
          </div>
        </div>

      </div>

      <div class="kbd">
        <div class="kbdTop">
          <div class="brand">
            <div class="yam">BANTU Ins.</div>
            <div class="cs01">RhS01</div>
            <div class="tag">MONO · WAVE MODES</div>
          </div>
          <div class="note" id="noteDisplay">---</div>
        </div>

        <div class="piano" id="piano">
          <div class="white-keys" id="whiteKeys"></div>
          <div class="black-keys" id="blackKeys"></div>
        </div>
      </div>
    </div>

    <div class="footer">WAVE buttons control MacroOSC modes · iPhone-first layout</div>
  </div>

<script>
/* ============================================================
   MACRO OSC host (mono) — no build
============================================================ */
let audioCtx = null;
let oscNode = null;
let filterNode = null;
let ampNode = null;
let currentNote = null;

const params = {
  mode: 0,           // 0..4
  timbre: 0.5,       // 0..1
  fm: 0.0,           // 0..1
  detune: 0.15,      // 0..1
  pw: 0.5,           // 0.05..0.95
  cutoff: 8000,
  resonance: 1.0,
  attack: 0.01,
  release: 0.5,
  sustain: 0.7,
  level: 0.7,
};

const MODES = [
  { id: 0, wave: "⊿", name: "VA SAW",    hint: "band-limited" },
  { id: 1, wave: "⊓", name: "PWM PULSE", hint: "pwm + blep" },
  { id: 2, wave: "≋", name: "SUPERSAW",  hint: "7 voices" },
  { id: 3, wave: "FM", name: "FM 2-OP",  hint: "metal/keys" },
  { id: 4, wave: "PD", name: "PD+FOLD",  hint: "cz/west" },
];

function noteToFreq(midi) {
  return 440 * Math.pow(2, (midi - 69) / 12);
}
function midiToName(midi) {
  const names = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
  return names[midi % 12] + Math.floor(midi / 12 - 1);
}

async function initAudio() {
  if (audioCtx) return;

  audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  await audioCtx.audioWorklet.addModule("./dsp/macro-osc.worklet.js");

  oscNode = new AudioWorkletNode(audioCtx, "macro-osc", {
    numberOfInputs: 0,
    numberOfOutputs: 1,
    outputChannelCount: [1],
  });

  filterNode = audioCtx.createBiquadFilter();
  filterNode.type = "lowpass";

  ampNode = audioCtx.createGain();
  ampNode.gain.value = 0;

  oscNode.connect(filterNode);
  filterNode.connect(ampNode);
  ampNode.connect(audioCtx.destination);

  applyAllParams();
}

function oscParam(name) {
  return oscNode?.parameters?.get(name) || null;
}

function applyAllParams() {
  if (!audioCtx) return;

  // osc
  oscParam("mode")?.setValueAtTime(params.mode, audioCtx.currentTime);
  oscParam("timbre")?.setValueAtTime(params.timbre, audioCtx.currentTime);
  oscParam("fm")?.setValueAtTime(params.fm, audioCtx.currentTime);
  oscParam("detune")?.setValueAtTime(params.detune, audioCtx.currentTime);
  oscParam("pw")?.setValueAtTime(params.pw, audioCtx.currentTime);
  oscParam("gain")?.setValueAtTime(1.0, audioCtx.currentTime);

  // filter
  filterNode.frequency.setValueAtTime(params.cutoff, audioCtx.currentTime);
  filterNode.Q.setValueAtTime(params.resonance, audioCtx.currentTime);
}

function gateOn() {
  const now = audioCtx.currentTime;
  ampNode.gain.cancelScheduledValues(now);
  ampNode.gain.setValueAtTime(ampNode.gain.value, now);
  ampNode.gain.linearRampToValueAtTime(params.level, now + params.attack);
  ampNode.gain.linearRampToValueAtTime(params.level * params.sustain, now + params.attack + 0.10);
}

function gateOff() {
  const now = audioCtx.currentTime;
  ampNode.gain.cancelScheduledValues(now);
  ampNode.gain.setValueAtTime(ampNode.gain.value, now);
  ampNode.gain.linearRampToValueAtTime(0, now + params.release);
}

async function playNote(midi) {
  await initAudio();
  if (audioCtx.state === "suspended") await audioCtx.resume();

  currentNote = midi;
  document.getElementById("noteDisplay").textContent = midiToName(midi);

  const freq = noteToFreq(midi);
  oscParam("freq")?.setValueAtTime(freq, audioCtx.currentTime);

  gateOn();
}

function stopNote() {
  if (!audioCtx) return;
  gateOff();
  currentNote = null;
  document.getElementById("noteDisplay").textContent = "---";
}

/* ============================================================
   UI: Mode buttons (WAVE -> MODE)
============================================================ */
const modeGrid = document.getElementById("modeGrid");

function renderModes() {
  modeGrid.innerHTML = "";
  MODES.forEach(m => {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "mode-btn" + (params.mode === m.id ? " active" : "");
    btn.innerHTML = `<b>${m.wave} ${m.name}</b><span>${m.hint}</span>`;
    btn.addEventListener("click", async () => {
      params.mode = m.id;
      // Update immediately
      if (audioCtx) oscParam("mode")?.setValueAtTime(params.mode, audioCtx.currentTime);
      renderModes();
    });
    modeGrid.appendChild(btn);
  });
}
renderModes();

/* ============================================================
   UI: Sliders helpers
============================================================ */
function setRangeVisual(el) {
  const v = parseFloat(el.value);
  const min = parseFloat(el.min);
  const max = parseFloat(el.max);
  const pct = ((v - min) / (max - min) * 100).toFixed(1) + "%";
  el.style.setProperty("--pct", pct);
}

function bindRange(id, onChange) {
  const el = document.getElementById(id);
  setRangeVisual(el);
  el.addEventListener("input", () => {
    setRangeVisual(el);
    onChange(parseFloat(el.value));
  });
}

bindRange("timbre", (v) => {
  params.timbre = v / 100;
  document.getElementById("v-timbre").textContent = params.timbre.toFixed(2);
  if (audioCtx) oscParam("timbre")?.setValueAtTime(params.timbre, audioCtx.currentTime);
});

bindRange("fm", (v) => {
  params.fm = v / 100;
  document.getElementById("v-fm").textContent = params.fm.toFixed(2);
  if (audioCtx) oscParam("fm")?.setValueAtTime(params.fm, audioCtx.currentTime);
});

bindRange("detune", (v) => {
  params.detune = v / 100;
  document.getElementById("v-detune").textContent = params.detune.toFixed(2);
  if (audioCtx) oscParam("detune")?.setValueAtTime(params.detune, audioCtx.currentTime);
});

bindRange("pw", (v) => {
  params.pw = Math.max(0.05, Math.min(0.95, v / 100));
  document.getElementById("v-pw").textContent = params.pw.toFixed(2);
  if (audioCtx) oscParam("pw")?.setValueAtTime(params.pw, audioCtx.currentTime);
});

bindRange("cutoff", (v) => {
  params.cutoff = v;
  document.getElementById("v-cutoff").textContent = Math.round(v);
  if (audioCtx) filterNode.frequency.setValueAtTime(params.cutoff, audioCtx.currentTime);
});

bindRange("resonance", (v) => {
  // slider 10..1800 -> Q 0.1..18
  params.resonance = (v / 100).toFixed(2) * 1;
  document.getElementById("v-reso").textContent = params.resonance.toFixed(2);
  if (audioCtx) filterNode.Q.setValueAtTime(params.resonance, audioCtx.currentTime);
});

bindRange("attack", (v) => {
  // 1..400 -> 0.001..0.4
  params.attack = Math.max(0.001, v / 1000);
  document.getElementById("v-att").textContent = params.attack.toFixed(3);
});

bindRange("release", (v) => {
  // 1..600 -> 0.001..0.6
  params.release = Math.max(0.001, v / 100);
  document.getElementById("v-rel").textContent = params.release.toFixed(2);
});

bindRange("sustain", (v) => {
  params.sustain = v / 100;
  document.getElementById("v-sus").textContent = params.sustain.toFixed(2);
});

bindRange("level", (v) => {
  params.level = v / 100;
  document.getElementById("v-level").textContent = params.level.toFixed(2);
});

/* init displayed values */
document.getElementById("v-timbre").textContent = params.timbre.toFixed(2);
document.getElementById("v-fm").textContent = params.fm.toFixed(2);
document.getElementById("v-detune").textContent = params.detune.toFixed(2);
document.getElementById("v-pw").textContent = params.pw.toFixed(2);
document.getElementById("v-cutoff").textContent = Math.round(params.cutoff);
document.getElementById("v-reso").textContent = params.resonance.toFixed(2);
document.getElementById("v-att").textContent = params.attack.toFixed(3);
document.getElementById("v-rel").textContent = params.release.toFixed(2);
document.getElementById("v-sus").textContent = params.sustain.toFixed(2);
document.getElementById("v-level").textContent = params.level.toFixed(2);

/* ============================================================
   Keyboard (touch-first)
============================================================ */
// 3 octaves starting at C3 (midi 48)
const startMidi = 48;
const numOctaves = 3;
const whitePattern = [0,2,4,5,7,9,11];
const blackPattern = [1,3,null,6,8,10,null];

const whiteKeysEl = document.getElementById("whiteKeys");
const blackKeysEl = document.getElementById("blackKeys");
const pianoEl = document.getElementById("piano");

const whiteKeys = [];
for (let o=0;o<numOctaves;o++){
  for (let i=0;i<7;i++){
    const midi = startMidi + o*12 + whitePattern[i];
    whiteKeys.push(midi);

    const key = document.createElement("div");
    key.className = "white-key";
    key.dataset.midi = midi;

    const down = (e) => { e.preventDefault(); playNote(midi); key.classList.add("active"); };
    const up   = (e) => { e.preventDefault(); stopNote(); key.classList.remove("active"); };

    key.addEventListener("touchstart", down, {passive:false});
    key.addEventListener("touchend", up, {passive:false});
    key.addEventListener("mousedown", (e)=>{ down(e); });
    key.addEventListener("mouseup", (e)=>{ up(e); });
    key.addEventListener("mouseleave", ()=>{ key.classList.remove("active"); });

    whiteKeysEl.appendChild(key);
  }
}

function buildBlackKeys(){
  blackKeysEl.innerHTML = "";
  const totalWhites = numOctaves * 7;
  const pianoW = pianoEl.clientWidth || 800;
  const whiteW = pianoW / totalWhites;

  let whiteIdx = 0;
  for (let o=0;o<numOctaves;o++){
    for (let i=0;i<7;i++){
      const semi = blackPattern[i];
      if (semi !== null){
        const midi = startMidi + o*12 + semi;
        const leftPct = ((whiteIdx + 0.65) * whiteW / pianoW * 100);
        const widthPct = (whiteW * 0.6 / pianoW * 100);

        const key = document.createElement("div");
        key.className = "black-key";
        key.dataset.midi = midi;
        key.style.left = leftPct + "%";
        key.style.width = widthPct + "%";

        const down = (e)=>{ e.preventDefault(); e.stopPropagation(); playNote(midi); key.classList.add("active"); };
        const up   = (e)=>{ e.preventDefault(); stopNote(); key.classList.remove("active"); };

        key.addEventListener("touchstart", down, {passive:false});
        key.addEventListener("touchend", up, {passive:false});
        key.addEventListener("mousedown", down);
        key.addEventListener("mouseup", up);
        key.addEventListener("mouseleave", ()=>{ key.classList.remove("active"); });

        blackKeysEl.appendChild(key);
      }
      whiteIdx++;
    }
  }
}

window.addEventListener("load", buildBlackKeys);
window.addEventListener("resize", buildBlackKeys);

/* Optional: keyboard shortcuts desktop */
const keyMap = {
  'a': 48, 'w': 49, 's': 50, 'e': 51, 'd': 52, 'f': 53,
  't': 54, 'g': 55, 'y': 56, 'h': 57, 'u': 58, 'j': 59,
  'k': 60, 'o': 61, 'l': 62, 'p': 63, ';': 64
};
document.addEventListener("keydown", e => {
  if (e.repeat) return;
  const midi = keyMap[e.key.toLowerCase()];
  if (midi !== undefined) playNote(midi);
});
document.addEventListener("keyup", e => {
  const midi = keyMap[e.key.toLowerCase()];
  if (midi !== undefined && currentNote === midi) stopNote();
});
</script>
</body>
</html>
